# Worklog: U6-T1 Kickoff（回帰品質ゲート最小実装）

- Date: 2026-02-21
- Task: U6開始定義と、U6-T1（`run_unity_tests.ps1` の artifact 必須判定）を最小実装し、4スイート回帰を実行して状態同期する
- Execution-Tool: Codex
- Execution-Agent: codex
- Execution-Model: gpt-5
- Used-Skills: phase-planning, worklog-update
- Repo-Refs:
  - `docs/NEXT_TASKS.md`
  - `docs/05-dev/dev-status.md`
  - `docs/05-dev/u5-llm-tts-stt-operations.md`
  - `docs/worklog/2026-02-21_u5_t4_phase_c_stt_integration.md`
  - `docs/worklog/2026-02-21_u5_t4_phase_c_progress_sync.md`
  - `tools/run_unity_tests.ps1`
- Obsidian-Refs:
  - `D:/Obsidian/Programming/MascotDesktop_obsidian_log_template.md`
  - `D:/dev/00_repository_templates/ai_playbook/skills/phase-planning/SKILL.md`
  - `D:/dev/00_repository_templates/ai_playbook/skills/worklog-update/SKILL.md`
- Report-Path: docs/worklog/2026-02-21_u6_t1_kickoff.md
- Obsidian-Log: D:/Obsidian/Programming/MascotDesktop_phaseNA_log_260221_2125.md
- Tags: [agent/codex, model/gpt-5, tool/codex, u6, u6-t1, regression-gate]

## Summary
U6をキックオフし、`docs/NEXT_TASKS.md` に目的/スコープ/DoDを新規定義した。
U6-T1として `tools/run_unity_tests.ps1` に `-RequireArtifacts` を追加し、artifact未生成を見落とさない実行ガードを実装した。
`docs/NEXT_TASKS.md` と `docs/05-dev/dev-status.md` を同期更新し、4スイート回帰実行結果（起動前失敗・artifact未生成）を反映した。

## Changes
1. `tools/run_unity_tests.ps1`
- `-RequireArtifacts` スイッチを追加。
- 指定時に xml/log artifact の存在を必須化し、未生成なら fail（exit 1）にする判定を追加。

2. `docs/NEXT_TASKS.md`
- Rev R17 を追加し、U6開始とU6-T1実装内容、4スイート実行失敗（起動前/未生成）を記録。
- U6セクション（目的/スコープ/非スコープ/DoD）を新規追加。
- U6タスク表を新規追加し、U6-T1をDoneとして記録。

3. `docs/05-dev/dev-status.md`
- 現状サマリーへ U6開始/U6-T1 実装を追記。
- 実装差分に `tools/run_unity_tests.ps1` の更新を追記。
- 現状NG/リスクへ 2026-02-21 21:24 の4スイート起動前失敗と artifact 未生成を追記。
- 標準運用へ `-RequireArtifacts` 使用ルールを追記。

## Commands
```powershell
./tools/run_unity_tests.ps1 -TestPlatform EditMode -TestFilter "MascotDesktop.Tests.EditMode.CoreOrchestratorSttIntegrationTests" -RequireArtifacts
./tools/run_unity_tests.ps1 -TestPlatform EditMode -TestFilter "MascotDesktop.Tests.EditMode.CoreOrchestratorTtsIntegrationTests" -RequireArtifacts
./tools/run_unity_tests.ps1 -TestPlatform EditMode -TestFilter "MascotDesktop.Tests.EditMode.CoreOrchestratorLlmIntegrationTests" -RequireArtifacts
./tools/run_unity_tests.ps1 -TestPlatform EditMode -TestFilter "MascotDesktop.Tests.EditMode.LoopbackHttpClientTests" -RequireArtifacts

Test-Path Unity_PJ/artifacts/test-results/editmode-20260221_212416.xml
Test-Path Unity_PJ/artifacts/test-results/editmode-20260221_212416.log
Test-Path Unity_PJ/artifacts/test-results/editmode-20260221_212425.xml
Test-Path Unity_PJ/artifacts/test-results/editmode-20260221_212425.log
```

## Tests
| run_at | suite | pass_fail | cause | artifact_xml | artifact_log |
|---|---|---|---|---|---|
| 2026-02-21 21:24:16 | CoreOrchestratorSttIntegrationTests | Failed (起動前) | Unity.exe / Unity.com とも `指定されたモジュールが見つかりません` | missing (`editmode-20260221_212416.xml`) | missing (`editmode-20260221_212416.log`) |
| 2026-02-21 21:24:25 | CoreOrchestratorTtsIntegrationTests | Failed (起動前) | Unity.exe / Unity.com とも `指定されたモジュールが見つかりません` | missing (`editmode-20260221_212425.xml`) | missing (`editmode-20260221_212425.log`) |
| 2026-02-21 21:24:25 | CoreOrchestratorLlmIntegrationTests | Failed (起動前) | Unity.exe / Unity.com とも `指定されたモジュールが見つかりません` | missing (`editmode-20260221_212425.xml`) | missing (`editmode-20260221_212425.log`) |
| 2026-02-21 21:24:25 | LoopbackHttpClientTests | Failed (起動前) | Unity.exe / Unity.com とも `指定されたモジュールが見つかりません` | missing (`editmode-20260221_212425.xml`) | missing (`editmode-20260221_212425.log`) |

## Tests 追補: -RequireArtifacts 動作確認（Antigravity）
- Execution-Tool: Antigravity / Execution-Model: gemini-2.5-pro

| run_at | suite | exit_code | -RequireArtifacts 判定 | artifact xml |
|---|---|---|---|---|
| 2026-02-21 21:32 | CoreOrchestratorSttIntegrationTests | 1 | artifact未生成を Write-Error + exit 1 で検知 ✅ | missing (`editmode-20260221_213239.xml`) |
| 2026-02-21 21:34 | CoreOrchestratorTtsIntegrationTests | 1 | 同上 ✅ | missing (`editmode-20260221_213407.xml`) |
| 2026-02-21 21:34 | CoreOrchestratorLlmIntegrationTests | 1 | 同上 ✅ | missing (`editmode-20260221_213441.xml`) |
| 2026-02-21 21:34 | LoopbackHttpClientTests | 1 | 同上 ✅ | missing (`editmode-20260221_213446.xml`) |

起動前失敗（artifact未生成）を `-RequireArtifacts` が確実に exit 1 で検知することを全4スイートで確認。U6-T1 の品質ゲート動作確認完了。

## Rationale (Key Points)
- 重大リスク: 起動前失敗時にartifact未生成が見落とされると、回帰結果の真偽判定が曖昧になる。
- 対策: `-RequireArtifacts` を実装し、artifact未生成を明示的に fail として扱う。
- 差分意図: U6開始時点で「実行失敗を検知して記録する基盤」を先に整備し、以降の回帰運用で判定一貫性を確保する。

## Rollback
- 変更戻し対象:
  - `tools/run_unity_tests.ps1`
  - `docs/NEXT_TASKS.md`
  - `docs/05-dev/dev-status.md`
  - `docs/worklog/2026-02-21_u6_t1_kickoff.md`
- Obsidianログは削除しない。
- ロールバック理由（何を・なぜ戻したか）を本worklogへ追記し、Obsidianに `Rolled back` / `Superseded` 注記を残す。

## Record Check
- Report-Path exists: True
- Repo-Refs populated: Yes
- Obsidian-Refs populated (or n/a): Yes
- Obsidian-Log recorded (path or reason): Yes
- Execution fields recorded: Yes
- Tags include agent/model/tool: Yes

## Next Actions
1. ~~Unity起動前失敗を復旧 → -RequireArtifacts 付きで4スイートを再実行~~ 部分完了: 動作確認済み（exit 1 で検知）、artifact採取は起動環境復旧後に実施。
2. U6-T2（回帰結果の集計テンプレート化）を `docs/NEXT_TASKS.md` に追加する。
3. U6-T2 の内容を `docs/05-dev/dev-status.md` に同期する。
